---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { generateDynamicMetadata, generateDynamicStructuredData } from "../../lib/seo-metadata.js";
import { siteConfig } from "../../lib/seo-config.js";
import blogData from '@/data/blog-posts.json';
import BlogPost from '../../components/blog/BlogPost.astro';

interface Props {
  slug: string;
  'blog-slug': string;
}

export async function getStaticPaths() {
  const params: Array<{ params: { slug: string; 'blog-slug': string } }> = [];
  
  // Generate category-based blog post routes (same as old site)
  blogData.blogPosts.forEach((post) => {
    params.push({
      params: {
        slug: post.category.slug,
        'blog-slug': post.slug,
      },
    });
  });
  
  return params;
}

const { slug: categorySlug, 'blog-slug': blogSlug } = Astro.params;

const blogPost = blogData.blogPosts.find((post) => 
  post.slug === blogSlug && post.category.slug === categorySlug
);

if (!blogPost) {
  return Astro.redirect('/404', 404);
}

// Extract keywords from SEO keywords string (same as old site)
const keywords = blogPost.seo.keywords.split(',').map(k => k.trim());

// Generate metadata
const metadata = generateDynamicMetadata(`/${categorySlug}/${blogSlug}/`, {
  title: blogPost.seo.metaTitle,
  description: blogPost.seo.metaDescription,
  content: blogPost.content,
  publishedTime: blogPost.publishedAt,
  modifiedTime: blogPost.updatedAt,
  author: blogPost.author.name,
  tags: blogPost.tags,
  keywords: keywords,
  image: blogPost.image?.url,
});

// Find related posts based on interlinking (same as old site)
const relatedPosts = blogPost.relatedPosts
  .map(relatedSlug => blogData.blogPosts.find(post => post.slug === relatedSlug))
  .filter((post): post is NonNullable<typeof post> => post !== undefined);

// Generate structured data with blog post schema
const structuredData = generateDynamicStructuredData(`/${categorySlug}/${blogSlug}/`, {
  blogPostData: {
    title: blogPost.title,
    slug: blogPost.slug,
    excerpt: blogPost.excerpt,
    content: blogPost.content,
    author: {
      name: blogPost.author.name,
      title: blogPost.author.bio || 'Content Writer',
      avatar: blogPost.author.avatar,
    },
    publishedAt: blogPost.publishedAt,
    updatedAt: blogPost.updatedAt,
    featuredImage: blogPost.image?.url || '/assets/images/Mike_s Garage Door Repair Center 21.webp',
    category: blogPost.category.name,
    tags: blogPost.tags,
    readTime: blogPost.readTime,
    seo: blogPost.seo,
  },
  breadcrumbs: [
    { name: 'Home', url: siteConfig.url },
    { name: blogPost.category.name, url: `${siteConfig.url}/${categorySlug}/` },
    { name: blogPost.title, url: `${siteConfig.url}/${categorySlug}/${blogSlug}/` },
  ],
});
---

<BaseLayout metadata={metadata}>
  <!-- Structured Data -->
  {structuredData.map((script) => (
    <script
      type={script.type}
      set:html={script.children}
    />
  ))}
  
  <BlogPost post={blogPost} relatedPosts={relatedPosts} />
</BaseLayout>

